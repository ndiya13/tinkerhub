{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Sidebar -->
    <div class="admin-sidebar">
        <div class="admin-profile">
            <div class="admin-avatar">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="admin-info">
                <h3>Admin Panel</h3>
                <p>{{ current_user.username }}</p>
            </div>
        </div>
        
        <nav class="admin-nav">
            <a href="#dashboard" class="active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="#users" data-tab="users">
                <i class="fas fa-users"></i> Users
            </a>
            <a href="#volunteers" data-tab="volunteers">
                <i class="fas fa-hands-helping"></i> Volunteer Applications
            </a>
            <a href="#disasters" data-tab="disasters">
                <i class="fas fa-exclamation-triangle"></i> Disaster Zones
            </a>
            <a href="#resources" data-tab="resources">
                <i class="fas fa-box-open"></i> Resource Requests
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="admin-main">
        <!-- Dashboard Overview -->
        <div class="admin-section active" id="dashboard">
            <h2>Dashboard Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon users">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Total Users</h3>
                        <p class="stat-number">{{ total_users }}</p>
                        <span class="stat-label">Registered Users</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon volunteers">
                        <i class="fas fa-hands-helping"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Volunteers</h3>
                        <p class="stat-number">{{ total_volunteers }}</p>
                        <span class="stat-label">Active Volunteers</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon pending">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Pending</h3>
                        <p class="stat-number">{{ pending_applications }}</p>
                        <span class="stat-label">Volunteer Applications</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon disasters">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Active Disasters</h3>
                        <p class="stat-number">{{ active_disasters }}</p>
                        <span class="stat-label">Disaster Zones</span>
                    </div>
                </div>
            </div>

            <div class="recent-activity">
                <h3>Recent Activity</h3>
                <div class="activity-list">
                    {% for activity in recent_activities %}
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="{{ activity.icon }}"></i>
                        </div>
                        <div class="activity-details">
                            <p>{{ activity.description }}</p>
                            <span class="activity-time">{{ activity.timestamp }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div class="admin-section" id="users">
            <h2>User Management</h2>
            <div class="search-bar">
                <input type="text" id="userSearch" placeholder="Search users...">
                <button class="btn btn-primary">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <div class="table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>
                                <span class="badge {% if user.is_volunteer %}volunteer{% endif %}">
                                    {{ "Volunteer" if user.is_volunteer else "User" }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge {{ user.status }}">
                                    {{ user.status }}
                                </span>
                            </td>
                            <td class="actions">
                                <button class="btn-icon" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Volunteer Applications -->
        <div class="admin-section" id="volunteers">
            <h2>Volunteer Applications</h2>
            <div class="applications-grid">
                {% for application in volunteer_applications %}
                <div class="application-card">
                    <div class="application-header">
                        <img src="{{ application.user.avatar or url_for('static', filename='images/default-avatar.png') }}" 
                             alt="Applicant Avatar">
                        <div class="applicant-info">
                            <h3>{{ application.user.username }}</h3>
                            <p>{{ application.user.email }}</p>
                        </div>
                    </div>
                    
                    <div class="application-details">
                        <div class="detail-item">
                            <i class="fas fa-tools"></i>
                            <h4>Skills</h4>
                            <div class="skills-tags">
                                {% for skill in application.skills.split(',') %}
                                <span class="tag">{{ skill.strip() }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="detail-item">
                            <i class="fas fa-briefcase"></i>
                            <h4>Experience</h4>
                            <p>{{ application.experience }}</p>
                        </div>
                        
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <h4>Location</h4>
                            <p>{{ application.location }}</p>
                        </div>
                    </div>
                    
                    <div class="application-actions">
                        <form action="{{ url_for('approve_volunteer', id=application.id) }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check"></i> Approve
                            </button>
                        </form>
                        <form action="{{ url_for('reject_volunteer', id=application.id) }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Disaster Zones -->
        <div class="admin-section" id="disasters">
            <h2>Disaster Zones</h2>
            <div class="disaster-controls">
                <button class="btn btn-primary" onclick="addDisaster()">
                    <i class="fas fa-plus"></i> Add New Disaster Zone
                </button>
                <div class="filter-controls">
                    <select id="disasterType">
                        <option value="">All Types</option>
                        <option value="earthquake">Earthquake</option>
                        <option value="flood">Flood</option>
                        <option value="hurricane">Hurricane</option>
                        <option value="wildfire">Wildfire</option>
                    </select>
                    <select id="disasterSeverity">
                        <option value="">All Severities</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
            </div>

            <div class="disasters-grid">
                {% for disaster in disasters %}
                <div class="disaster-card">
                    <div class="disaster-header {{ disaster.severity }}">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>{{ disaster.type }}</h3>
                        <span class="severity-badge">{{ disaster.severity }}</span>
                    </div>
                    
                    <div class="disaster-body">
                        <div class="disaster-info">
                            <p><i class="fas fa-map-marker-alt"></i> {{ disaster.location }}</p>
                            <p><i class="fas fa-calendar"></i> {{ disaster.date }}</p>
                        </div>
                        
                        <div class="resource-needs">
                            <h4>Required Resources</h4>
                            <ul>
                                {% for resource in disaster.required_resources %}
                                <li>
                                    <span class="resource-type">{{ resource.type }}</span>
                                    <span class="resource-quantity">{{ resource.quantity }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <div class="volunteer-count">
                            <i class="fas fa-users"></i>
                            <span>{{ disaster.assigned_volunteers }} Volunteers Assigned</span>
                        </div>
                    </div>
                    
                    <div class="disaster-actions">
                        <form action="{{ url_for('edit_disaster', id=disaster.id) }}" method="GET" style="display: inline;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </form>
                        <form action="{{ url_for('delete_disaster', id=disaster.id) }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this disaster zone?');">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// Tab switching functionality
document.querySelectorAll('.admin-nav a').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Remove active class from all links and sections
        document.querySelectorAll('.admin-nav a').forEach(l => l.classList.remove('active'));
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        
        // Add active class to clicked link and corresponding section
        this.classList.add('active');
        document.getElementById(this.getAttribute('data-tab')).classList.add('active');
    });
});

// Updated volunteer application handling functions
function approveVolunteer(id) {
    if (confirm('Are you sure you want to approve this volunteer?')) {
        // Add CSRF token if you're using Flask-WTF
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch(`/admin/approve-volunteer/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success message
                alert('Volunteer application approved successfully!');
                // Reload the page to update the UI
                window.location.reload();
            } else {
                alert('Error: ' + (data.message || 'Failed to approve volunteer'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error processing request. Please try again.');
        });
    }
}

function rejectVolunteer(id) {
    if (confirm('Are you sure you want to reject this volunteer?')) {
        // Add CSRF token if you're using Flask-WTF
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        fetch(`/admin/reject-volunteer/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success message
                alert('Volunteer application rejected successfully!');
                // Reload the page to update the UI
                window.location.reload();
            } else {
                alert('Error: ' + (data.message || 'Failed to reject volunteer'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error processing request. Please try again.');
        });
    }
}

// Search functionality
document.getElementById('userSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.admin-table tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Disaster management functions
function editDisaster(id) {
    if (!id) return;
    
    // Add CSRF token if you're using Flask-WTF
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // You could either redirect to an edit page
    window.location.href = `/admin/edit-disaster/${id}`;
    
    // Or handle it with a modal/form on the same page
    // showEditDisasterModal(id);  // Implement this if you want modal functionality
}

function deleteDisaster(id) {
    if (!id || !confirm('Are you sure you want to delete this disaster zone?')) {
        return;
    }
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`/admin/delete-disaster/${id}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('Disaster zone deleted successfully!');
            window.location.reload();
        } else {
            alert('Error: ' + (data.message || 'Failed to delete disaster zone'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error processing request. Please try again.');
    });
}

function addDisaster() {
    // Redirect to the add disaster page
    window.location.href = '/admin/add-disaster';
    
    // Or show a modal form
    // showAddDisasterModal();  // Implement this if you want modal functionality
}
</script>
{% endblock %} 